#!/usr/bin/perl
# vim:set shiftwidth=4 softtabstop=4 expandtab:
#
# File: test_get_win.pl
# Date: 7 July 2009
# Author: Michael Ciesla <mick.ciesla@gmail.com>
#  (based on test_packet_forwarding)
#
# Description
#
#  Verifies that the Windows (TCP hdr = 20B) HTTP GET packets are duplicated. 
#
use strict;
use NF2::RegressLib;
use NF2::PacketLib;
use RegressRouterLib;
        
use reg_defines_reference_router;

my @interfaces = ("nf2c0", "nf2c1", "nf2c2", "nf2c3", "eth1", "eth2");
nftest_init(\@ARGV,\@interfaces,);
nftest_start(\@interfaces);

my $routerMAC0 = "00:ca:fe:00:00:01";
my $routerMAC1 = "00:ca:fe:00:00:02";
my $routerMAC2 = "00:ca:fe:00:00:03";
my $routerMAC3 = "00:ca:fe:00:00:04";

my $routerIP0 = "192.168.0.40";
my $routerIP1 = "192.168.1.40";
my $routerIP2 = "192.168.2.40";
my $routerIP3 = "192.168.3.40";

# clear LPM table
for (my $i = 0; $i < 32; $i++)
{
  nftest_invalidate_LPM_table_entry('nf2c0', $i);
}

# clear ARP table
for (my $i = 0; $i < 32; $i++)
{
  nftest_invalidate_ARP_table_entry('nf2c0', $i);
}

# Write the mac and IP addresses
nftest_add_dst_ip_filter_entry ('nf2c0', 0, $routerIP0);
nftest_add_dst_ip_filter_entry ('nf2c1', 1, $routerIP1);
nftest_add_dst_ip_filter_entry ('nf2c2', 2, $routerIP2);
nftest_add_dst_ip_filter_entry ('nf2c3', 3, $routerIP3);

nftest_set_router_MAC ('nf2c0', $routerMAC0);
nftest_set_router_MAC ('nf2c1', $routerMAC1);
nftest_set_router_MAC ('nf2c2', $routerMAC2);
nftest_set_router_MAC ('nf2c3', $routerMAC3);

# packet payload - TCP hdr and HTTP GET message
my @DATA = (0x05, 0x19, 0x00, 0x50, 0xd5, 0x90, 
0x71, 0x38, 0x3e, 0xb5, 0xb1, 0x74, 0x50, 0x18, 
0xff, 0xff, 0x37, 0xb9, 0x00, 0x00, 0x47, 0x45, 
0x54, 0x20, 0x2f, 0x69, 0x6d, 0x61, 0x67, 0x65, 
0x73, 0x2f, 0x6e, 0x65, 0x77, 0x73, 0x70, 0x61, 
0x70, 0x65, 0x72, 0x2e, 0x67, 0x69, 0x66, 0x20, 
0x48, 0x54, 0x54, 0x50, 0x2f, 0x31, 0x2e, 0x31, 
0x0d, 0x0a, 0x41, 0x63, 0x63, 0x65, 0x70, 0x74, 
0x3a, 0x20, 0x2a, 0x2f, 0x2a, 0x0d, 0x0a, 0x52, 
0x65, 0x66, 0x65, 0x72, 0x65, 0x72, 0x3a, 0x20, 
0x68, 0x74, 0x74, 0x70, 0x3a, 0x2f, 0x2f, 0x77, 
0x77, 0x77, 0x2e, 0x67, 0x6f, 0x6f, 0x67, 0x6c, 
0x65, 0x2e, 0x63, 0x6f, 0x6d, 0x2e, 0x61, 0x75, 
0x2f, 0x73, 0x65, 0x61, 0x72, 0x63, 0x68, 0x3f, 
0x68, 0x6c, 0x3d, 0x65, 0x6e, 0x26, 0x71, 0x3d, 
0x69, 0x63, 0x65, 0x2b, 0x63, 0x72, 0x65, 0x61, 
0x6d, 0x26, 0x6d, 0x65, 0x74, 0x61, 0x3d, 0x0d, 
0x0a, 0x41, 0x63, 0x63, 0x65, 0x70, 0x74, 0x2d, 
0x4c, 0x61, 0x6e, 0x67, 0x75, 0x61, 0x67, 0x65, 
0x3a, 0x20, 0x65, 0x6e, 0x2d, 0x75, 0x73, 0x0d, 
0x0a, 0x41, 0x63, 0x63, 0x65, 0x70, 0x74, 0x2d, 
0x45, 0x6e, 0x63, 0x6f, 0x64, 0x69, 0x6e, 0x67, 
0x3a, 0x20, 0x67, 0x7a, 0x69, 0x70, 0x2c, 0x20, 
0x64, 0x65, 0x66, 0x6c, 0x61, 0x74, 0x65, 0x0d, 
0x0a, 0x55, 0x73, 0x65, 0x72, 0x2d, 0x41, 0x67, 
0x65, 0x6e, 0x74, 0x3a, 0x20, 0x4d, 0x6f, 0x7a, 
0x69, 0x6c, 0x6c, 0x61, 0x2f, 0x34, 0x2e, 0x30, 
0x20, 0x28, 0x63, 0x6f, 0x6d, 0x70, 0x61, 0x74, 
0x69, 0x62, 0x6c, 0x65, 0x3b, 0x20, 0x4d, 0x53, 
0x49, 0x45, 0x20, 0x36, 0x2e, 0x30, 0x3b, 0x20, 
0x57, 0x69, 0x6e, 0x64, 0x6f, 0x77, 0x73, 0x20, 
0x4e, 0x54, 0x20, 0x35, 0x2e, 0x31, 0x3b, 0x20, 
0x53, 0x56, 0x31, 0x3b, 0x20, 0x49, 0x6e, 0x66, 
0x6f, 0x50, 0x61, 0x74, 0x68, 0x2e, 0x31, 0x29, 
0x0d, 0x0a, 0x48, 0x6f, 0x73, 0x74, 0x3a, 0x20, 
0x77, 0x77, 0x77, 0x2e, 0x67, 0x6f, 0x6f, 0x67, 
0x6c, 0x65, 0x2e, 0x63, 0x6f, 0x6d, 0x2e, 0x61, 
0x75, 0x0d, 0x0a, 0x43, 0x6f, 0x6e, 0x6e, 0x65, 
0x63, 0x74, 0x69, 0x6f, 0x6e, 0x3a, 0x20, 0x4b, 
0x65, 0x65, 0x70, 0x2d, 0x41, 0x6c, 0x69, 0x76, 
0x65, 0x0d, 0x0a, 0x43, 0x6f, 0x6f, 0x6b, 0x69, 
0x65, 0x3a, 0x20, 0x50, 0x52, 0x45, 0x46, 0x3d, 
0x49, 0x44, 0x3d, 0x66, 0x65, 0x66, 0x38, 0x33, 
0x34, 0x36, 0x63, 0x32, 0x36, 0x65, 0x38, 0x64, 
0x62, 0x31, 0x38, 0x3a, 0x54, 0x4d, 0x3d, 0x31, 
0x32, 0x33, 0x38, 0x30, 0x32, 0x37, 0x33, 0x35, 
0x34, 0x3a, 0x4c, 0x4d, 0x3d, 0x31, 0x32, 0x33, 
0x38, 0x30, 0x32, 0x37, 0x33, 0x35, 0x34, 0x3a, 
0x53, 0x3d, 0x45, 0x6a, 0x65, 0x48, 0x68, 0x46, 
0x46, 0x62, 0x54, 0x37, 0x78, 0x2d, 0x31, 0x54, 
0x51, 0x4a, 0x3b, 0x20, 0x4e, 0x49, 0x44, 0x3d, 
0x32, 0x31, 0x3d, 0x78, 0x6f, 0x71, 0x57, 0x78, 
0x55, 0x7a, 0x64, 0x7a, 0x47, 0x32, 0x32, 0x59, 
0x30, 0x4c, 0x36, 0x7a, 0x55, 0x44, 0x42, 0x7a, 
0x58, 0x36, 0x39, 0x53, 0x66, 0x4b, 0x78, 0x70, 
0x75, 0x44, 0x79, 0x71, 0x41, 0x33, 0x64, 0x59, 
0x6f, 0x4e, 0x72, 0x52, 0x65, 0x65, 0x55, 0x48, 
0x37, 0x78, 0x4a, 0x45, 0x59, 0x58, 0x35, 0x49, 
0x4c, 0x5f, 0x65, 0x74, 0x4b, 0x4c, 0x53, 0x47, 
0x4f, 0x5a, 0x4f, 0x30, 0x62, 0x55, 0x5f, 0x5f, 
0x66, 0x72, 0x73, 0x35, 0x46, 0x30, 0x55, 0x56, 
0x5a, 0x67, 0x6e, 0x50, 0x49, 0x6d, 0x45, 0x58, 
0x77, 0x6e, 0x74, 0x70, 0x4d, 0x45, 0x70, 0x56, 
0x34, 0x6d, 0x36, 0x4c, 0x75, 0x42, 0x42, 0x4a, 
0x6a, 0x6c, 0x5f, 0x38, 0x6d, 0x54, 0x77, 0x70, 
0x39, 0x72, 0x64, 0x6f, 0x34, 0x64, 0x39, 0x49, 
0x4a, 0x43, 0x41, 0x4f, 0x70, 0x6e, 0x4b, 0x63, 
0x66, 0x64, 0x5a, 0x0d, 0x0a, 0x0d, 0x0a);

# add an entry in the routing table:
my $index = 0;
my $subnetIP = "192.168.2.0";
my $subnetIP2 = "192.168.1.0";
my $subnetMask = "255.255.255.0";
my $subnetMask2 = "255.255.255.0";
my $nextHopIP = "192.168.1.54";
my $nextHopIP2 = "192.168.3.12";
my $outPort = 0x1; # output on MAC0
my $outPort2 = 0x4;
my $nextHopMAC = "dd:55:dd:66:dd:77";

nftest_add_LPM_table_entry ('nf2c0',
			    1,
			    $subnetIP,
			    $subnetMask,
			    $nextHopIP,
			    $outPort);

nftest_add_LPM_table_entry ('nf2c0',
			    0,
			    $subnetIP2,
			    $subnetMask2,
			    $nextHopIP2,
			    $outPort2);


# add an entry in the ARP table
nftest_add_ARP_table_entry('nf2c0',
			   $index,
			   $nextHopIP,
			   $nextHopMAC);

# add an entry in the ARP table
nftest_add_ARP_table_entry('nf2c0',
			   1,
			   $nextHopIP2,
			   $nextHopMAC);

my $total_errors = 0;
my $temp_error_val = 0;

#clear the num pkts forwarded reg
nftest_regwrite('nf2c0', ROUTER_OP_LUT_NUM_PKTS_FORWARDED_REG, 0);

for (my $i = 0; $i < 20; $i++) {
	# Send HTTP GET packet from eth1 to eth2
	# set parameters
	my $DA = $routerMAC0;
	my $SA = "aa:bb:cc:dd:ee:ff";
	my $TTL = 64;
	my $proto = 0x06; # tcp
	my $DST_IP = "192.168.1.1"; 
	my $SRC_IP = "192.168.0.1";
        ##my $len = 100;
	my $nextHopMAC = "dd:55:dd:66:dd:77";
	
	# create mac header
	my $MAC_hdr = NF2::Ethernet_hdr->new(DA => $DA,
					        SA => $SA,
						Ethertype => 0x800
					        );
	
	# create packet filling.... (IP PDU)
	my $PDU = NF2::PDU->new();
	$PDU->set_bytes(@DATA);
	my $PDU_len = $PDU->length_in_bytes();
	
	#create IP header
	my $IP_hdr = NF2::IP_hdr->new(ttl => $TTL,
	                                proto => $proto,
	                                src_ip => $SRC_IP,
	                                dst_ip => $DST_IP,
					dgram_len => 20 + $PDU_len, # IP hdr is 20 bytes.
	                               );
	
	$IP_hdr->checksum(0);  # make sure its zero before we calculate it.
	$IP_hdr->checksum($IP_hdr->calc_checksum);
	
	# get packed packet string
	my $sent_pkt = $MAC_hdr->packed . $IP_hdr->packed . $PDU->packed;
	
	# create the expected packet
	my $MAC_hdr2 = NF2::Ethernet_hdr->new(DA => $nextHopMAC,
						SA => $routerMAC1,
						Ethertype => 0x800
					    	);
	
	
	$IP_hdr->ttl($TTL-1);
	$IP_hdr->checksum(0);  # make sure its zero before we calculate it.
	$IP_hdr->checksum($IP_hdr->calc_checksum);
	
	my $expected_pkt = $MAC_hdr2->packed . $IP_hdr->packed . $PDU->packed;
	
	# send packet out of eth1->eth2 and nf2c0 (duplicated)
	nftest_send('eth1', $sent_pkt);
	nftest_expect('eth2', $expected_pkt);
	nftest_expect('nf2c0', $expected_pkt);
	`usleep 500`;
}

# loop for 20 packets from eth2 to eth1
for (my $i = 0; $i < 20; $i++)
{
	# set parameters
	my $DA = $routerMAC1;
	my $SA = "aa:bb:cc:dd:ee:ff";
	my $TTL = 64;
	my $proto = 0x06; # tcp
	my $DST_IP = "192.168.2.1"; 
	my $SRC_IP = "192.168.0.1";
	my $nextHopMAC = "dd:55:dd:66:dd:77";

	# create mac header
	my $MAC_hdr = NF2::Ethernet_hdr->new(DA => $DA,
					        SA => $SA,
						Ethertype => 0x800
					        );
	
	# create packet filling.... (IP PDU)
	my $PDU = NF2::PDU->new();
	$PDU->set_bytes(@DATA);
	my $PDU_len = $PDU->length_in_bytes();
	
	#create IP header
	my $IP_hdr = NF2::IP_hdr->new(ttl => $TTL,
	                                proto => $proto,
	                                src_ip => $SRC_IP,
	                                dst_ip => $DST_IP,
					dgram_len => 20 + $PDU_len, # IP hdr is 20 bytes.
	                               );
	
	$IP_hdr->checksum(0);  # make sure its zero before we calculate it.
	$IP_hdr->checksum($IP_hdr->calc_checksum);
	
	# get packed packet string
	my $sent_pkt = $MAC_hdr->packed . $IP_hdr->packed . $PDU->packed;
	
	# create the expected packet
	my $MAC_hdr2 = NF2::Ethernet_hdr->new(DA => $nextHopMAC,
						SA => $routerMAC0,
						Ethertype => 0x800
					    	);
	
	
	$IP_hdr->ttl($TTL-1);
	$IP_hdr->checksum(0);  # make sure its zero before we calculate it.
	$IP_hdr->checksum($IP_hdr->calc_checksum);
	
	my $expected_pkt = $MAC_hdr2->packed . $IP_hdr->packed . $PDU->packed;

	# send packet out of eth2 -> eth1 & nf2c0 
	nftest_send('eth2', $sent_pkt);
	nftest_expect('eth1', $expected_pkt);
	nftest_expect('nf2c0', $expected_pkt);
	`usleep 500`;  
}

sleep 1;
my $unmatched_hoh = nftest_finish();
$total_errors += nftest_print_errors($unmatched_hoh);

# Check registers to see how many packets have been forwarded
$temp_error_val += nftest_regread_expect('nf2c0', ROUTER_OP_LUT_NUM_PKTS_FORWARDED_REG, 40);

if ($temp_error_val == 40 && $total_errors == 0) {
  print "SUCCESS!\n";
	exit 0;
}
elsif ($temp_error_val != 40) {
  print "Expected 40 packets forwarded. Forwarded $temp_error_val\n";
	exit 1;
}
else {
	print "Failed: $total_errors $temp_error_val errors\n";	
	exit 1;
}

